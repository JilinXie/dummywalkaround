
<div>
    <canvas id="yard" width="200" height="150" style="background-color: grey"></canvas>
</div>
<button onclick="start()"> start </button>

<script>
    let sound = document.createElement("audio");
    sound.src = "bgm.mp3";
    sound.setAttribute("preload", "auto");
    sound.setAttribute("controls", "none");
    sound.style.display = "none";
    document.body.appendChild(sound);

    let canv = document.getElementById('yard');
    let ctx = canv.getContext("2d");

    let sprites = new Image();
    sprites.src = "sprites.png";
    let swid = 24;
    let shei = 32;
    let hero = {back: [[0, 0], [2, 0], [1, 0]],
                right: [[0, 1], [2, 1], [1, 1]],
                front: [[0, 2], [2, 2], [1, 2]],
                left: [[0, 3], [2, 3], [1, 3]]};
    let steps = {left: [-12, 0], right: [12, 0],
                 front: [0, 16], back: [0, -16]}
    let hero_pos = [parseInt(canv.width/2/swid)*swid, parseInt(canv.height/2/shei)*shei];
 

    // s_x, s_y: x and y in sprite-sheet
    // m_x, m_y: position on map.
    let draw_sprite = function(s_x, s_y, m_x, m_y) {
        console.log("draw: " + m_x + ' ' + m_y + ' ' + s_x + ' ' + s_y);
        ctx.drawImage(sprites, s_x*swid, s_y*shei,
                      swid, shei, m_x, m_y, swid, shei);
    };
    let boundary_valid = function(m_x, m_y) {
        if (m_x >= canv.width-swid || m_y >= canv.height-shei ||
            m_x <= 0 || m_y <=0) {
            return false;
        }
        return true;
    }

    let walk_step = 0
    let prev_time = 0;
    let walk = function(direction) {
        let cur = window.performance.now();
        if (cur - prev_time < 300) {
            return;
        }
        prev_time = cur;
        let new_step = (walk_step+1) % 2;
        let s_x = hero[direction][new_step][0]
        let s_y = hero[direction][new_step][1];
        walk_step = new_step;

        ctx.clearRect(hero_pos[0], hero_pos[1], swid, shei);
        console.log("clear: " + hero_pos[0] + ' ' + hero_pos[1]);
        if (boundary_valid(hero_pos[0] + steps[direction][0], hero_pos[1] + steps[direction][1])) {
            hero_pos[0] += steps[direction][0];
            hero_pos[1] += steps[direction][1];
        }
        draw_sprite(s_x, s_y, hero_pos[0], hero_pos[1]);
    };

    let stand = function(direction) {
        let s_x = hero[direction][2][0]
        let s_y = hero[direction][2][1]
        draw_sprite(s_x, s_y, hero_pos[0], hero_pos[1]);
    }


    let start = function() {
        draw_sprite(hero.front[1][0], hero.front[1][1], hero_pos[0], hero_pos[1]);
        sound.play();

        window.addEventListener("keydown", function(event) {
            let code = event.keyCode;
            if (code === 37) {
                walk("left");
                console.log("left");
            } else if (code === 39) {
                walk("right");
                console.log("right");
            } else if (code === 38) {
                walk("back");
                console.log("up");
            } else if (code === 40) {
                walk("front");
                console.log("down");
            }

        });
        window.addEventListener("keyup", function(event) {
            let code = event.keyCode;
            if (code === 37) {
                stand("left");
                console.log("up left");
            } else if (code === 39) {
                stand("right");
                console.log("up right");
            } else if (code === 38) {
                stand("back");
                console.log("up up");
            } else if (code === 40) {
                stand("front");
                console.log("up down");
            }

        });
    };

    /*
    var draw = function(container) {
        let walk = function() {
            let cur = window.performance.now();
            if (cur - prev_time < 500) {
                //
            } else {
                prev_time = cur;
                let hero_x, hero_y;
                if (icon_num == 0) {
                    hero_x = smap.hero_fr[0] * swid;
                    hero_y = smap.hero_fr[1] * shei;
                } else if (icon_num == 1) {
                    hero_x = smap.hero_fl[0] * swid;
                    hero_y = smap.hero_fl[1] * shei;
                }

                icon_num = (icon_num+1)%2;
                ctx.clearRect(hero_pos[0], hero_pos[1], swid, shei);
                ctx.drawImage(sprites, hero_x, hero_y,
                              swid, shei, hero_pos[0], hero_pos[1], swid, shei);
            }
            window.requestAnimationFrame(walk);
        }
        window.requestAnimationFrame(walk);
    }
    */
</script>

